<!DOCTYPE html>
<html>

<head>
    <title>é€±è¡¨ç”Ÿæˆå™¨</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <style>
        @font-face {
            font-family: 'GenSekiGothic';
            src: url('GenSekiGothic-H.ttf') format('truetype');
        }

        @font-face {
            font-family: 'GenSenRounded';
            src: url('GenSenRounded-M.ttf') format('truetype');
        }

        body {
            font-family: Arial, sans-serif;
        }

        #controls {
            text-align: center;
        }
    </style>
</head>

<body>
    <div id="controls" class="container mt-4">
        <h2><b>é€±è¡¨ç”Ÿæˆå™¨</b></h2>
        <h6>å˜Ÿæ¯”ã€å’©é†¬ã€æ—­å…ƒã€å¦®é…·ã€CBã€èŠ±ç‡ã€ç…¦</h6>
        <hr>
        <form>
            <div class="row mb-3">
                <div class="col">
                    <h4><b>é‡è¦ç¯€ç›®</b></h4>
                    <p>å¡«å¯«1~7ã€‚ä½¿ç”¨ã€Œ,ã€åšåˆ†é›¢ï¼ˆä¾‹ï¼š1,2,7ï¼‰</p>
                </div>
                <div class="col">
                    <h4><b>ä¸é–‹æ’­é è¨­å¥</b></h4>
                </div>
            </div>
            <div class="row mb-3">
                <div class="col">
                    <input type="text" class="form-control" id="highlight-doubi" placeholder="å˜Ÿæ¯”">
                </div>
                <div class="col">
                    <input type="text" class="form-control" id="default-doubi" value="é˜¿æ¯”ç”¨åŠ›æ“ çªç™¼" placeholder="å˜Ÿæ¯”çš„é è¨­ç¯€ç›®">
                </div>
            </div>
            <div class="row mb-3">
                <div class="col">
                    <input type="text" class="form-control" id="highlight-miejiang" placeholder="å’©é†¬">
                </div>
                <div class="col">
                    <input type="text" class="form-control" id="default-miejiang" value="å’©é†¬æµ·å·¡" placeholder="å’©é†¬çš„é è¨­ç¯€ç›®">
                </div>
            </div>
            <div class="row mb-3">
                <div class="col">
                    <input type="text" class="form-control" id="highlight-xuyuan" placeholder="æ—­å…ƒ">
                </div>
                <div class="col">
                    <input type="text" class="form-control" id="default-xuyuan" value="åŠ©æ•™ä¼‘æ¯" placeholder="æ—­å…ƒçš„é è¨­ç¯€ç›®">
                </div>
            </div>
            <div class="row mb-3">
                <div class="col">
                    <input type="text" class="form-control" id="highlight-nico" placeholder="å¦®é…·">
                </div>
                <div class="col">
                    <input type="text" class="form-control" id="default-nico" value="å¦®åœ¨åŠªåŠ›æˆ´ç‰™å¥—" placeholder="å¦®é…·çš„é è¨­ç¯€ç›®">
                </div>
            </div>
            <div class="row mb-3">
                <div class="col">
                    <input type="text" class="form-control" id="highlight-cb" placeholder="CB">
                </div>
                <div class="col">
                    <input type="text" class="form-control" id="default-cb" value="BBåœ¨å·¥ä½œ" placeholder="CBçš„é è¨­ç¯€ç›®">
                </div>
            </div>
            <div class="row mb-3">
                <div class="col">
                    <input type="text" class="form-control" id="highlight-hualin" placeholder="èŠ±ç‡">
                </div>
                <div class="col">
                    <input type="text" class="form-control" id="default-hualin" value="èŠ±åœ’ä¼‘æ¯é´¨" placeholder="èŠ±ç‡çš„é è¨­ç¯€ç›®">
                </div>
            </div>
            <div class="row mb-3">
                <div class="col">
                    <input type="text" class="form-control" id="highlight-xu" placeholder="ç…¦">
                </div>
                <div class="col">
                    <input type="text" class="form-control" id="default-xu" value="ç ”ç¿’ç¾Šæ—ç§˜è¡“" placeholder="ç…¦çš„é è¨­ç¯€ç›®">
                </div>
            </div>
            <hr>
            <button type="button" class="btn btn-primary" onclick="generateImages()">ç”Ÿæˆé€±è¡¨ (éœ€ç­‰å¾…å¹¾ç§’)</button>
            <hr>
            <div class="mb-3">
                <h4><b>é‡è¦ç¯€ç›®æ–‡å­—</b></h4>
                <textarea class="form-control" id="exampleFormControlTextarea1" rows="10"></textarea>
            </div>

        </form>

    </div>
    <div class="container-lg text-center">
        <a id="download1" class="btn btn-info mt-3" role="button" style="display:none;">ä¸‹è¼‰åœ–ç‰‡1</a>
        <canvas id="canvas-preview1" class="img-fluid"></canvas>
        <a id="download2" class="btn btn-info mt-3" role="button" style="display:none;">ä¸‹è¼‰åœ–ç‰‡2</a>
        <canvas id="canvas-preview2" class="img-fluid"></canvas>
        <canvas id="canvas1" style="display:none;"></canvas>
        <canvas id="canvas2" style="display:none;"></canvas>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
    <script>
        async function loadFonts() {
            const genSekiGothic = new FontFace('GenSekiGothic', 'url(GenSekiGothic-H.ttf)');
            const genSenRounded = new FontFace('GenSenRounded', 'url(GenSenRounded-M.ttf)');
            await genSekiGothic.load();
            await genSenRounded.load();
            document.fonts.add(genSekiGothic);
            document.fonts.add(genSenRounded);
        }

        async function fetchSheetData() {
            const randomParam = Math.floor(Math.random() * 1000000);
            const url = `https://docs.google.com/spreadsheets/d/e/2PACX-1vTki1Xo06YY9v8v8gVqnNF3PyKGmTYlYBwt_FJDzYaUTZID10WaOy53-NeznTznftvgQLzHLVeXKe1N/pub?gid=1734652110&single=true&output=csv&random=${randomParam}`;
            const response = await fetch(url);
            const text = await response.text();
            const data = text.split('\n').map(row => row.split(','));
            const firstRow = data[0];
            const last50Rows = data.slice(-50);
            const filteredData = [firstRow, ...last50Rows];

            console.log(filteredData);
            return filteredData;
        }

        function processEventName(eventName) {
            let isImportant = false;

            if (eventName.includes("ä¸é–‹å°)ã€‘")) {
                eventName += "(ä¸é–‹å°)";
            }
            if (eventName.includes("ç´…ç›´æ’­") || eventName.includes("ç´…é€£å‹•")) {
                isImportant = true;
            }

            eventName = eventName.split('ã€‘').slice(1).join('ã€‘');
            eventName = eventName.replace("å®¢åº§ï¼š", "").replace("æ´»å‹•ï¼š", "");
            // return eventName;
            return { eventName, isImportant };
        }

        function drawTextCentered(ctx, text, font, fontSize, centerX, centerY, fillColor) {
            ctx.font = `${fontSize}px ${font}`;
            ctx.fillStyle = fillColor;
            const textWidth = ctx.measureText(text).width;
            const textHeight = fontSize;
            ctx.fillText(text, centerX - textWidth / 2, centerY + textHeight / 4);
        }

        function getWeekDates() {
            const now = new Date();
            const startOfWeek = new Date(now);
            startOfWeek.setDate(now.getDate() - now.getDay() + 1);
            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 6);
            startOfWeek.setHours(0, 0, 0, 0);
            endOfWeek.setHours(23, 59, 59, 999);
            return { startOfWeek, endOfWeek };
        }

        async function generateImages() {
            await loadFonts();
            const data = await fetchSheetData();
            const canvas1 = document.getElementById('canvas1');
            const ctx1 = canvas1.getContext('2d');
            const canvas2 = document.getElementById('canvas2');
            const ctx2 = canvas2.getContext('2d');
            const background1 = new Image();
            const background2 = new Image();

            background1.src = 'bg1.png';
            background2.src = 'bg2.png';

            await Promise.all([
                new Promise(resolve => background1.onload = resolve),
                new Promise(resolve => background2.onload = resolve)
            ]);

            canvas1.width = background1.width;
            canvas1.height = background1.height;
            canvas2.width = background2.width;
            canvas2.height = background2.height;

            ctx1.drawImage(background1, 0, 0);
            ctx2.drawImage(background2, 0, 0);

            const { startOfWeek, endOfWeek } = getWeekDates();

            const weekRange = `${(startOfWeek.getMonth() + 1).toString().padStart(2, '0')}/${startOfWeek.getDate().toString().padStart(2, '0')}~${(endOfWeek.getMonth() + 1).toString().padStart(2, '0')}/${endOfWeek.getDate().toString().padStart(2, '0')}`;
            drawTextCentered(ctx1, weekRange, 'GenSekiGothic', 25, 167, 324, '#f4f4f4');
            drawTextCentered(ctx2, weekRange, 'GenSekiGothic', 25, 167, 324, '#f4f4f4');

            const artists = ["å˜Ÿæ¯”", "å’©é†¬", "æ—­å…ƒ", "å¦®é…·", "CB", "èŠ±ç‡", "ç…¦"];
            const artistsDefault = {
                "å˜Ÿæ¯”": [["ï¼", document.getElementById('default-doubi').value || "é˜¿æ¯”ç”¨åŠ›æ“ çªç™¼"]],
                "å’©é†¬": [["ï¼", document.getElementById('default-miejiang').value || "å’©é†¬æµ·å·¡"]],
                "æ—­å…ƒ": [["ï¼", document.getElementById('default-xuyuan').value || "åŠ©æ•™ä¼‘æ¯"]],
                "å¦®é…·": [["ï¼", document.getElementById('default-nico').value || "å¦®åœ¨åŠªåŠ›æˆ´ç‰™å¥—"]],
                "CB": [["ï¼", document.getElementById('default-cb').value || "BBåœ¨å·¥ä½œ"]],
                "èŠ±ç‡": [["ï¼", document.getElementById('default-hualin').value || "èŠ±åœ’ä¼‘æ¯é´¨"]],
                "ç…¦": [["ï¼", document.getElementById('default-xu').value || "ç ”ç¿’ç¾Šæ—ç§˜è¡“"]],
            };
            const highlightDay = {
                "å˜Ÿæ¯”": document.getElementById('highlight-doubi').value.split(',').map(Number).filter(n => !isNaN(n) && n !== 0),
                "å’©é†¬": document.getElementById('highlight-miejiang').value.split(',').map(Number).filter(n => !isNaN(n) && n !== 0),
                "æ—­å…ƒ": document.getElementById('highlight-xuyuan').value.split(',').map(Number).filter(n => !isNaN(n) && n !== 0),
                "å¦®é…·": document.getElementById('highlight-nico').value.split(',').map(Number).filter(n => !isNaN(n) && n !== 0),
                "CB": document.getElementById('highlight-cb').value.split(',').map(Number).filter(n => !isNaN(n) && n !== 0),
                "èŠ±ç‡": document.getElementById('highlight-hualin').value.split(',').map(Number).filter(n => !isNaN(n) && n !== 0),
                "ç…¦": document.getElementById('highlight-xu').value.split(',').map(Number).filter(n => !isNaN(n) && n !== 0),
            };

            const schedule = {};
            const importantEvents = [];

            for (const artist of artists) {
                schedule[artist] = {};
                for (let i = 0; i < 7; i++) {
                    const date = new Date(startOfWeek);
                    date.setDate(date.getDate() + i);
                    const dateStr = `${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getDate().toString().padStart(2, '0')}`;
                    schedule[artist][dateStr] = artistsDefault[artist];
                }
            }
            console.log('schedule is ', schedule);

            for (const row of data) {
                if (row.length < 10) continue;
                const dateStr = row[4];
                if (!dateStr) continue;
                const datePart = dateStr.split(' ')[0];
                const date = new Date(`${new Date().getFullYear()}/${datePart}`);
                if (startOfWeek <= date && date <= endOfWeek) {
                    const time = row[5];
                    for (let i = 0; i < artists.length; i++) {
                        const artist = artists[i];
                        let event = row[i + 6];
                        if (!event) continue;

                        // event = processEventName(event.slice(5));
                        // ä½¿ç”¨ processEventName ä¸¦è§£æ§‹
                        const { eventName, isImportant } = processEventName(event.slice(5));


                        if (!schedule[artist][datePart]) {
                            schedule[artist][datePart] = [];
                        }
                        if (schedule[artist][datePart][0][0] === "ï¼") {
                            // schedule[artist][datePart] = [[time, event]];
                            schedule[artist][datePart] = [[time, { eventName, isImportant }]];

                        } else {
                            // schedule[artist][datePart].push([time, event]);
                            schedule[artist][datePart].push([time, { eventName, isImportant }]);

                        }
                        const eventDay = date.getDay() === 0 ? 7 : date.getDay();
                        if (highlightDay[artist].length > 0  && highlightDay[artist].includes(eventDay) || isImportant) {
                            console.log(` ${artist} ï½œ ${highlightDay[artist].length}`);
                            importantEvents.push(`${datePart} ${artist}ï½œ${eventName}`);
                        }

                    }
                }
            }
            console.log('schedule is ', schedule);

            const artistPositions = {
                "å˜Ÿæ¯”": [504, 387 + 3],
                "å’©é†¬": [901, 387 + 3],
                "æ—­å…ƒ": [1299, 387 + 3],
                "å¦®é…·": [1697, 387 + 3],
                "CB": [504, 387 + 3],
                "èŠ±ç‡": [901, 387 + 3],
                "ç…¦": [1299, 387 + 3]
            };

            for (const artist of artists) {
                const position = artistPositions[artist];
                const startX = position[0];
                const startY = position[1];
                let index = 0;

                for (const [date, events] of Object.entries(schedule[artist])) {
                    const y = startY + index * 95;

                    events.forEach((event, j) => {
                        const [ time, eventData ] = event;
                        // console.log('event is ', event);
                        // console.log('time is ', time);
                        // console.log('eventData is ', eventData);

                        let { eventName, isImportant } = eventData;
                        if (typeof eventData === 'string') {
                            eventName = eventData;
                        }
                        // console.log('eventName is ', eventName);

                        let fontSize;
                        if (eventName) {
                            fontSize = eventName.length > 20 ? 16 : eventName.length > 15 ? 18 : 20;
                        }
                        const fillColor = isImportant || highlightDay[artist].includes(new Date(date).getDay() + 1) ? '#E5202F' : '#000000';

                        const xOffset = events.length === 1 ? 0 : 70 * (j * 2 - 1);

                        if (artists.slice(0, 4).includes(artist)) {
                            drawTextCentered(ctx1, time, 'GenSenRounded', 23, startX + xOffset, y, time === 'ï¼' ? '#808080' : fillColor);
                            drawTextCentered(ctx1, eventName, 'GenSenRounded', fontSize, startX + xOffset, y + 34, time === 'ï¼' ? '#808080' : fillColor);
                        } else {
                            drawTextCentered(ctx2, time, 'GenSenRounded', 23, startX + xOffset, y, time === 'ï¼' ? '#808080' : fillColor);
                            drawTextCentered(ctx2, eventName, 'GenSenRounded', fontSize, startX + xOffset, y + 34, time === 'ï¼' ? '#808080' : fillColor);
                        }
                        console.log('eventName is ', eventData);

                       

                    });

                    index++;
                }
            }

            // ç¸®å°é è¦½åœ–
            const previewCanvas1 = document.getElementById('canvas-preview1');
            const previewCtx1 = previewCanvas1.getContext('2d');
            const previewCanvas2 = document.getElementById('canvas-preview2');
            const previewCtx2 = previewCanvas2.getContext('2d');
            const previewScale = 1;  // ç¸®å°æ¯”ä¾‹

            previewCanvas1.width = canvas1.width * previewScale;
            previewCanvas1.height = canvas1.height * previewScale;
            previewCtx1.drawImage(canvas1, 0, 0, previewCanvas1.width, previewCanvas1.height);

            previewCanvas2.width = canvas2.width * previewScale;
            previewCanvas2.height = canvas2.height * previewScale;
            previewCtx2.drawImage(canvas2, 0, 0, previewCanvas2.width, previewCanvas2.height);


            const downloadLink1 = document.getElementById('download1');
            const downloadLink2 = document.getElementById('download2');

            downloadLink1.href = canvas1.toDataURL('image/png');
            downloadLink1.download = 'output1.png';
            downloadLink1.style.display = 'block';

            downloadLink2.href = canvas2.toDataURL('image/png');
            downloadLink2.download = 'output2.png';
            downloadLink2.style.display = 'block';

            // ç”Ÿæˆé‡è¦ç¯€ç›®æ–‡å­—
            const importantEventsText = `â­ã€å¤¢ç®±ï½œé€±è¡Œç¨‹ã€‘ ${weekRange}\n\næœ¬é€±ç²¾å½©çœ‹é»ğŸ‘‡\n${importantEvents.join('\n')}\n\n#å¤¢æƒ³ä¹‹éƒ½å·¥ä½œå®¤ #ç®±é€±è¡¨ #Vtuber`;
            document.getElementById('exampleFormControlTextarea1').value = importantEventsText;

            // ä½¿ç”¨Blobå°è±¡å°‡å…©å¼µåœ–ç‰‡æ‰“åŒ…ç‚ºä¸€å€‹å£“ç¸®æ–‡ä»¶
            // const zip = new JSZip();
            // zip.file('output1.png', canvas1.toDataURL('image/png').split(',')[1], { base64: true });
            // zip.file('output2.png', canvas2.toDataURL('image/png').split(',')[1], { base64: true });
            // zip.generateAsync({ type: 'blob' }).then(function (content) {
            //     const zipLink = document.createElement('a');
            //     zipLink.href = URL.createObjectURL(content);
            //     zipLink.download = 'weekly_schedules.zip';
            //     zipLink.click();
            // });
        }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.5.0/jszip.min.js"></script>
</body>

</html>