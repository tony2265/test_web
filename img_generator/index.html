<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ–ç‰‡å­—å¹•ç”¢ç”Ÿå™¨</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@simonwep/pickr/dist/themes/classic.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/@simonwep/pickr"></script>
    
    <style>
        @font-face {
            font-family: 'GenSenRounded';
            src: url('GenSenRounded2TW-M.otf') format('opentype');
        }

        @font-face {
            font-family: 'NotoSansTC';
            src: url('NotoSansTC-Medium.ttf') format('truetype');
        }

        @font-face {
            font-family: 'SourceHanSerifTC';
            src: url('SourceHanSerifTC-Medium.otf') format('opentype');
        }


        body {
            font-family: 'GenSenRounded', sans-serif;
            background-color: #f8f9fa;
            padding: 40px;
        }

        h2 {
            margin-bottom: 30px;
            font-weight: 700;
        }

        .canvas-wrapper {
            max-width: 100%;
            overflow: auto;
        }

        canvas {
            width: 100%;
            height: auto;
            max-width: 100%;
            border: 1px solid #ced4da;
            background-color: #000;
        }

        .text-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 6px;
        }

        .text-row input {
            flex: 1;
            font-size: 1.1rem;
            padding: 6px 10px;
        }

        #downloadLink {
            display: none;
        }
    </style>
</head>

<body class="container">
    <h2 class="text-center">åœ–ç‰‡å­—å¹•ç”¢ç”Ÿå™¨</h2>
    <div class="mb-3 row g-2 align-items-center">
        <div class="col-md-6">
            <input type="file" class="form-control" id="imageInput" accept="image/png, image/jpeg">
        </div>
        <div class="col-md-6">
            <button class="btn btn-primary w-100" onclick="pasteFromClipboard()">ğŸ“‹è²¼ä¸Šå‰ªè²¼ç°¿åœ–ç‰‡</button>
        </div>
    </div>
    <div class="mb-2" id="uploadStatus"></div>

    <hr>
    <h4 class="text-center my-4">æ–‡å­—è¼¸å…¥å€</h4>

    <div id="textInputs" class=""></div>
    <div class="text-center mb-4">
        <button class="btn btn-success w-100" onclick="addTextInput()">+ å¢åŠ æ–‡å­—æ¬„</button>
    </div>
    <hr>
    <h4 class="text-center my-4">åœ–ç‰‡ç”Ÿæˆå€</h4>


    <div class="row">
        <!-- å·¦å´ï¼šå¾®èª¿é¸é … -->
        <div class="col-md-4">
            <!-- <button class="btn btn-sm btn-secondary mb-3 w-100" onclick="toggleImageControls()">å¾®èª¿é¸é …</button> -->
            <div id="imageControls" class="mb-4 border rounded p-3">
                <!-- åŸæœ¬å¾®èª¿é¸é …å…§çš„å…§å®¹ï¼ˆæ‹‰æ¡¿ã€é¸å–®ã€Pickrï¼‰åŸå°ä¸å‹•æ”¾é€™è£¡ -->

                <label class="form-label">åœ–ç‰‡ç¸®æ”¾ï¼ˆ%ï¼‰ï¼š<input type="range" class="form-range" id="scaleInput" min="50"
                        max="150" value="100"></label>
                <label class="form-label">åœ–ç‰‡Xè»¸åç§»ï¼ˆpxï¼‰ï¼š<input type="range" class="form-range" id="offsetXInput" min="-300"
                        max="300" value="0"></label>
                <label class="form-label">åœ–ç‰‡Yè»¸åç§»ï¼ˆpxï¼‰ï¼š<input type="range" class="form-range" id="offsetYInput" min="-300"
                        max="300" value="0"></label>
                <label class="form-label">æ–‡å­—Xè»¸åç§»ï¼ˆpxï¼‰ï¼š<input type="range" class="form-range" id="textOffsetX"
                        min="-300" max="300" value="0"></label>
                <label class="form-label">æ–‡å­—Yè»¸åç§»ï¼ˆpxï¼‰ï¼š<input type="range" class="form-range" id="textOffsetY"
                        min="-300" max="300" value="0"></label>

                <label class="form-label">å­—é«”å¤§å°ï¼ˆpxï¼‰ï¼š<input type="range" class="form-range" id="fontSizeInput" min="24"
                        max="80" value="48"></label>
                <label class="form-label">è¡Œè·ï¼ˆpxï¼‰ï¼š<input type="range" class="form-range" id="lineSpacingInput" min="10"
                        max="100" value="30"></label>
                <label class="form-label">å­—é«”ç²—ç´°ï¼ˆweightï¼‰ï¼š<input type="range" class="form-range" id="fontWeightInput"
                        min="100" max="900" step="100" value="400"></label>

                <div class="d-flex flex-wrap gap-4 align-items-center mt-3">
                    <div class="d-flex align-items-center gap-2">
                        <label class="form-label mb-0" style="min-width: 90px;">å­—é«”é¸æ“‡ï¼š</label>
                        <select id="fontFamilySelect" class="form-select" onchange="generateImage()"
                            style="font-family: inherit;">
                            <option value="GenSenRounded" style="font-family: 'GenSenRounded'; font-weight: 400;">
                                GenSenRounded
                            </option>
                            <option value="NotoSansTC" style="font-family: 'NotoSansTC'; font-weight: 400;">NotoSansTC
                            </option>
                            <option value="SourceHanSerifTC" style="font-family: 'SourceHanSerifTC'; font-weight: 400;">
                                SourceHanSerifTC</option>
                        </select>
                    </div>

                    <div class="d-flex align-items-center gap-2">
                        <label for="textColorPicker" class="form-label mb-0">æ–‡å­—é¡è‰²ï¼š</label>
                        <div id="textColorPicker"></div>
                    </div>
                    <div class="d-flex align-items-center gap-2">
                        <label for="bgColorPicker" class="form-label mb-0">èƒŒæ™¯é¡è‰²ï¼š</label>
                        <div id="bgColorPicker"></div>
                    </div>
                </div>

                <!-- æ–°å¢ï¼šè¼¸å‡ºæ¯”ä¾‹é¸å–® -->
                <div class="mb-3">
                    <label class="form-label">è¼¸å‡ºæ¯”ä¾‹ï¼š</label>
                    <select id="aspectRatioSelect" class="form-select" onchange="changeAspectRatio()">
                        <option value="1:1" selected>1:1 (æ­£æ–¹å½¢)</option>
                        <option value="16:9">16:9 (æ©«å‘)</option>
                    </select>
                </div>

                <div class="text-end">
                    <button class="btn btn-sm btn-outline-dark" onclick="resetImageControls()">é è¨­å€¼</button>
                </div>

            </div>
        </div>

        <!-- å³å´ï¼šåœ–ç‰‡èˆ‡ä¸‹è¼‰ -->
        <div class="col-md-8">
            <div class="text-center">
                <a id="downloadLink" class="btn btn-success w-100" download="result.jpg">ä¸‹è¼‰åœ–ç‰‡</a>
            </div>
            <div class="canvas-wrapper text-center">
                <!-- ä¿®æ”¹ï¼šcanvas åˆå§‹å¯¬é«˜è¨­ç‚º 1200x1200ï¼Œå¾ŒçºŒç”± JS æ§åˆ¶ -->
                <canvas id="resultCanvas" width="1200" height="1200"></canvas>
            </div>
        </div>
    </div>



    <script>
        let uploadedImage = null;
        let textColor = 'rgb(255,255,255)';
        let bgColor = 'rgba(0,0,0,0.9)';
        let aspectRatio = "1:1"; // æ–°å¢ï¼šé è¨­æ¯”ä¾‹

        const pickrText = Pickr.create({
            el: '#textColorPicker',
            theme: 'classic',
            default: textColor,
            components: {
                preview: true,
                opacity: true,
                hue: true,
                interaction: {
                    input: true,
                    save: true
                }
            }
        });
        pickrText.on('save', (color) => {
            textColor = color.toHEXA().toString();
            generateImage();
        });

        const pickrBg = Pickr.create({
            el: '#bgColorPicker',
            theme: 'classic',
            default: bgColor,
            components: {
                preview: true,
                opacity: true,
                hue: true,
                interaction: {
                    input: true,
                    save: true
                }
            }
        });
        pickrBg.on('save', (color) => {
            bgColor = color.toHEXA().toString();
            generateImage();
        });

        const uploadStatus = document.getElementById("uploadStatus");

        function changeAspectRatio() {
            aspectRatio = document.getElementById("aspectRatioSelect").value;
            const canvas = document.getElementById("resultCanvas");
            if (aspectRatio === "1:1") {
                canvas.width = 1200;
                canvas.height = 1200;
            } else if (aspectRatio === "16:9") {
                canvas.width = 1600;
                canvas.height = 900;
            }
            generateImage();
        }

        function resetImageControls() {
            document.getElementById("scaleInput").value = 100;
            document.getElementById("offsetXInput").value = 0;
            document.getElementById("offsetYInput").value = 0;
            document.getElementById("textOffsetX").value = 0;
            document.getElementById("textOffsetY").value = 0;
            document.getElementById("fontSizeInput").value = 48;
            document.getElementById("lineSpacingInput").value = 30;
            document.getElementById("fontWeightInput").value = 400;
            document.getElementById("fontFamilySelect").value = "GenSenRounded";
            textColor = 'rgb(255,255,255)';
            bgColor = 'rgba(0,0,0,0.9)';
            pickrText.setColor(textColor);
            pickrBg.setColor(bgColor);
            document.getElementById("aspectRatioSelect").value = "1:1";
            changeAspectRatio();


            generateImage();
        }

        function toggleImageControls() {
            const controls = document.getElementById("imageControls");
            controls.classList.toggle("d-none");
        }

        function addTextInput(defaultText = '', autoFocus = false) {
            const container = document.getElementById("textInputs");
            const wrapper = document.createElement("div");
            wrapper.className = "text-row";
            wrapper.innerHTML = `
        <input type="text" class="form-control" placeholder="è¼¸å…¥æ–‡å­—å…§å®¹..." value="${defaultText}" 
            oninput="generateImage()" 
            onkeydown="handleTextInputKey(event, this)">
        <button class="btn btn-outline-danger btn-sm" onclick="this.parentNode.remove(); generateImage();">åˆªé™¤</button>
      `;
            container.appendChild(wrapper);
            if (autoFocus) {
                // è‡ªå‹• focus æ–°å¢çš„ input
                const input = wrapper.querySelector('input');
                input.focus();
            }
        }

        // æ–°å¢ï¼šè™•ç† Enter éµäº‹ä»¶
        function handleTextInputKey(e, inputElem) {
            if (e.key === 'Enter') {
                addTextInput('', true);
                e.preventDefault();
            }
        }

        function drawRoundedRect(ctx, x, y, width, height, radius) {
            ctx.beginPath();
            ctx.moveTo(x + radius, y);
            ctx.lineTo(x + width - radius, y);
            ctx.quadraticCurveTo(x + width, y, x + width, y + radius);
            ctx.lineTo(x + width, y + height - radius);
            ctx.quadraticCurveTo(x + width, y + height, x + width - radius, y + height);
            ctx.lineTo(x + radius, y + height);
            ctx.quadraticCurveTo(x, y + height, x, y + height - radius);
            ctx.lineTo(x, y + radius);
            ctx.quadraticCurveTo(x, y, x + radius, y);
            ctx.closePath();
        }

        document.getElementById("imageInput").addEventListener("change", function (e) {
            const reader = new FileReader();
            reader.onload = function (event) {
                const img = new Image();
                img.onload = function () {
                    uploadedImage = img;
                    uploadStatus.innerText = "âœ… åœ–ç‰‡ä¸Šå‚³å®Œæˆï¼";
                    generateImage();
                }
                img.src = event.target.result;
            }
            reader.readAsDataURL(e.target.files[0]);
        });

        ["scaleInput", "offsetXInput", "offsetYInput", "fontSizeInput", "lineSpacingInput", "fontFamilySelect", "fontWeightInput","textOffsetX","textOffsetY"].forEach(id => {
            document.getElementById(id).addEventListener("input", generateImage);
        });

        async function pasteFromClipboard() {
            try {
                const clipboardItems = await navigator.clipboard.read();
                for (const item of clipboardItems) {
                    for (const type of item.types) {
                        if (type.startsWith("image/")) {
                            const blob = await item.getType(type);
                            const url = URL.createObjectURL(blob);
                            const img = new Image();
                            img.onload = () => {
                                uploadedImage = img;
                                uploadStatus.innerText = "âœ… åœ–ç‰‡ä¸Šå‚³å®Œæˆï¼ˆå‰ªè²¼ç°¿ï¼‰ï¼";
                                generateImage();
                            };
                            img.src = url;
                        }
                    }
                }
            } catch (err) {
                alert("è²¼ä¸Šå¤±æ•—: " + err);
            }
        }

        const textOffsetXInput = document.createElement('input');
        textOffsetXInput.id = 'textOffsetX';
        const textOffsetYInput = document.createElement('input');
        textOffsetYInput.id = 'textOffsetY';

        function generateImage() {
            const canvas = document.getElementById("resultCanvas");
            const ctx = canvas.getContext("2d");

            const scalePercent = parseFloat(document.getElementById("scaleInput").value) || 100;
            const offsetXValue = parseFloat(document.getElementById("offsetXInput").value) || 0;
            const offsetYValue = parseFloat(document.getElementById("offsetYInput").value) || 0;
            const textOffsetX = parseFloat(document.getElementById("textOffsetX")?.value) || 0;
            const textOffsetY = parseFloat(document.getElementById("textOffsetY")?.value) || 0;
            const fontSize = parseFloat(document.getElementById("fontSizeInput").value) || 48;
            const lineSpacing = parseFloat(document.getElementById("lineSpacingInput").value) || 30;

            // æ ¹æ“šæ¯”ä¾‹èª¿æ•´åº•è‰²
            ctx.fillStyle = "black";
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            if (uploadedImage) {
                // æ ¹æ“šæ¯”ä¾‹èª¿æ•´åœ–ç‰‡ç¸®æ”¾èˆ‡ç½®ä¸­
                const scale = Math.max(canvas.width / uploadedImage.width, canvas.height / uploadedImage.height) * (scalePercent / 100);
                const imgWidth = uploadedImage.width * scale;
                const imgHeight = uploadedImage.height * scale;
                const offsetX = (canvas.width - imgWidth) / 2 + offsetXValue;
                const offsetY = (canvas.height - imgHeight) / 2 + offsetYValue;
                ctx.drawImage(uploadedImage, offsetX, offsetY, imgWidth, imgHeight);
            }

            const inputs = document.querySelectorAll("#textInputs input");
            const textLines = Array.from(inputs).map(input => input.value).filter(text => text);

            // æ ¹æ“šæ¯”ä¾‹èª¿æ•´æ–‡å­—å€åŸŸçš„åº•éƒ¨è·é›¢
            let baseY;
            if (aspectRatio === "1:1") {
                baseY = canvas.height - 50 - (textLines.length * fontSize + (textLines.length - 1) * lineSpacing) + textOffsetY;
            } else if (aspectRatio === "16:9") {
                baseY = canvas.height - 40 - (textLines.length * fontSize + (textLines.length - 1) * lineSpacing) + textOffsetY;
            }

            const selectedFont = document.getElementById("fontFamilySelect")?.value || "GenSenRounded";
            const fontWeight = parseInt(document.getElementById("fontWeightInput")?.value) || 400;
            ctx.font = `${fontWeight} ${fontSize}px '${selectedFont}', sans-serif`;
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";

            textLines.forEach((text, index) => {
                const y = baseY + index * (fontSize + lineSpacing) + fontSize / 2;
                const textWidth = ctx.measureText(text).width;
                const padding = 32;

                ctx.fillStyle = bgColor;
                drawRoundedRect(ctx, (canvas.width - textWidth) / 2 - padding + textOffsetX, y - fontSize / 2 - 10, textWidth + padding * 2, fontSize + 20, 12);
                ctx.fill();

                ctx.fillStyle = textColor;
                ctx.fillText(text, canvas.width / 2 + textOffsetX, y);
            });

            const link = document.getElementById("downloadLink");
            link.href = canvas.toDataURL("image/jpeg");
            link.style.display = "inline-block";
        }

        window.onload = () => {
            addTextInput();
            changeAspectRatio(); // åˆå§‹åŒ–æ¯”ä¾‹
        };
    </script>
</body>

</html>